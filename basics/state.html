<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Contract state - Sylvia book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Guide to building CosmWasm smart contracts">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started</li><li class="chapter-item expanded "><a href="../setting-up-env.html"><strong aria-hidden="true">1.</strong> Setting up the environment</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start.html"><strong aria-hidden="true">2.</strong> Quick start with wasmd</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../wasmd-quick-start/testnet.html"><strong aria-hidden="true">2.1.</strong> Testnet setup</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start/preparing-account.html"><strong aria-hidden="true">2.2.</strong> Preparing account</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start/testnet-interaction.html"><strong aria-hidden="true">2.3.</strong> Interaction with testnet</a></li><li class="chapter-item expanded "><a href="../basics/building-contract.html"><strong aria-hidden="true">2.4.</strong> Building the contract</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Smart contracts</li><li class="chapter-item expanded "><a href="../basics.html"><strong aria-hidden="true">3.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basics/create-project.html"><strong aria-hidden="true">3.1.</strong> Create a Rust project</a></li><li class="chapter-item expanded "><a href="../basics/entry-points.html"><strong aria-hidden="true">3.2.</strong> Entry points</a></li><li class="chapter-item expanded "><a href="../basics/first-messages.html"><strong aria-hidden="true">3.3.</strong> Generating first messages</a></li><li class="chapter-item expanded "><a href="../basics/state.html" class="active"><strong aria-hidden="true">3.4.</strong> Contract state</a></li><li class="chapter-item expanded "><a href="../basics/query.html"><strong aria-hidden="true">3.5.</strong> Creating a query</a></li><li class="chapter-item expanded "><a href="../basics/query-testing.html"><strong aria-hidden="true">3.6.</strong> Testing a query</a></li><li class="chapter-item expanded "><a href="../basics/multitest-intro.html"><strong aria-hidden="true">3.7.</strong> Introducing multitest</a></li><li class="chapter-item expanded "><a href="../basics/execute.html"><strong aria-hidden="true">3.8.</strong> Execution messsages</a></li><li class="chapter-item expanded "><a href="../basics/events.html"><strong aria-hidden="true">3.9.</strong> Events attributes and data</a></li><li class="chapter-item expanded "><a href="../basics/funds.html"><strong aria-hidden="true">3.10.</strong> Dealing with funds</a></li><li class="chapter-item expanded "><a href="../basics/good-practices.html"><strong aria-hidden="true">3.11.</strong> Good practices</a></li><li class="chapter-item expanded "><a href="../basics/fp-types.html"><strong aria-hidden="true">3.12.</strong> Floating point types</a></li><li class="chapter-item expanded "><a href="../basics/reusability.html"><strong aria-hidden="true">3.13.</strong> Reusability</a></li></ol></li><li class="chapter-item expanded "><a href="../actor-model.html"><strong aria-hidden="true">4.</strong> The Actor Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../actor-model/idea.html"><strong aria-hidden="true">4.1.</strong> The idea</a></li><li class="chapter-item expanded "><a href="../actor-model/actors-in-blockchain.html"><strong aria-hidden="true">4.2.</strong> Actors in the blockchain</a></li><li class="chapter-item expanded "><a href="../actor-model/contract-as-actor.html"><strong aria-hidden="true">4.3.</strong> Contract as an actor</a></li></ol></li><li class="chapter-item expanded "><a href="../impressum.html">Legal Information</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sylvia book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="contract-state"><a class="header" href="#contract-state">Contract state</a></h1>
<p>We can instantiate our contract, but it doesn't do anything afterward.
Let's make it more complex. In this chapter we will introduce the contracts state.</p>
<h2 id="adding-contract-state"><a class="header" href="#adding-contract-state">Adding contract state</a></h2>
<p>We will initialize the on contract instantiation. The state
will contain a list of admins who would be eligible to execute messages in the future.</p>
<p>The first thing to do is to update <code>Cargo.toml</code> with yet another dependency - the
<a href="https://crates.io/crates/cw-storage-plus"><code>storage-plus</code></a> crate with high-level bindings for
CosmWasm smart contracts state management:</p>
<pre><code class="language-toml">[package]
name = &quot;contract&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
cosmwasm-std = { version = &quot;1.1&quot;, features = [&quot;staking&quot;] }
cosmwasm-schema = &quot;1.1.6&quot;
serde = { version = &quot;1.0.147&quot;, features = [&quot;derive&quot;] }
sylvia = &quot;0.2.1&quot;
schemars = &quot;0.8.11&quot;
cw-storage-plus = &quot;1.0&quot;
</code></pre>
<p>Now add the state as a field in your contract and instantiate it in the <code>new</code> method.</p>
<pre><code class="language-rust noplayground">use cosmwasm_std::{Addr, DepsMut, Empty, Env, MessageInfo, Response, StdResult};
use cw_storage_plus::Map;
use schemars;
use sylvia::contract;

pub struct AdminContract&lt;'a&gt; {
    pub(crate) admins: Map&lt;'a, &amp;'a Addr, Empty&gt;,
}

#[contract]
impl AdminContract&lt;'_&gt; {
    pub const fn new() -&gt; Self {
        Self {
            admins: Map::new(&quot;admins&quot;),
        }
    }

    #[msg(instantiate)]
    pub fn instantiate(
        &amp;self,
        _ctx: (DepsMut, Env, MessageInfo),
    ) -&gt; StdResult&lt;Response&gt; {
        Ok(Response::new())
    }
}
</code></pre>
<p>New types:</p>
<ul>
<li>
<p><a href="https://docs.rs/cw-storage-plus/0.16.0/cw_storage_plus/struct.Map.html"><code>Map&lt;_, _&gt;</code></a></p>
</li>
<li>
<p><a href="https://docs.rs/cosmwasm-std/0.16.0/cosmwasm_std/struct.Addr.html"><code>Addr</code></a> - representation of
actual address on a blockchain.</p>
</li>
<li>
<p><a href="https://docs.rs/cosmwasm-std/0.16.0/cosmwasm_std/struct.Empty.html"><code>Empty</code></a> - an empty struct
that serves as a placeholder.</p>
</li>
</ul>
<p>We declared state <code>admins</code> as immutable <code>Map&lt;'a, &amp;'a Addr, Empty&gt;</code>.
It might seem weird that we created <code>Map</code> with an <code>Empty</code> value containing no information. Still,
our alternative would be to store it as <code>Vec&lt;Addr&gt;</code>, forcing us to load whole the <code>Vec</code> to
alternate it or read a single element which would be a costly operation.
Because of that, it is better to declare it as a <code>Map</code>.</p>
<p>But why isn't it mutable? How will we modify the elements?</p>
<p>The answer is tricky - this immutable is not keeping the state itself. The state is stored in the
blockchain, and we can access it via the <code>deps</code> argument passed to entry points. The storage-plus
constants are just accessor utilities helping us access this state in a structured way.</p>
<p>In CosmWasm, the blockchain state is just massive key-value storage. The keys are prefixed with
metainformation pointing to the contract which owns them (so no other contract can alter them),
but even after removing the prefixes, the single contract state is a smaller key-value pair.</p>
<p><code>storage-plus</code> handles more complex state structures by additionally prefixing item keys
intelligently. The key to the <code>Map</code> doesn't matter to us - it would be figured out to be unique
based on a unique string passed to the
<a href="https://docs.rs/cw-storage-plus/0.13.4/cw_storage_plus/struct.Item.html#method.new"><code>new</code></a> method.</p>
<p>Last new thing. We crated the <code>new</code> method for the <code>AdminContract</code> to hide the instantiation of
the fields.</p>
<h2 id="initializing-the-state"><a class="header" href="#initializing-the-state">Initializing the state</a></h2>
<p>Now that the state field has been added we can improve our instantiate. We will make it possible for
a user to add new admins at contract instantiation.</p>
<pre><code class="language-rust noplayground">use cosmwasm_std::{Addr, DepsMut, Empty, Env, MessageInfo, Response};
use cw_storage_plus::Map;
use schemars;
use sylvia::contract;
<span class="boring">
</span><span class="boring">pub struct AdminContract&lt;'a&gt; {
</span><span class="boring">   pub(crate) admins: Map&lt;'a, &amp;'a Addr, Empty&gt;,
</span><span class="boring">}
</span>
#[contract]
impl AdminContract&lt;'_&gt; {
<span class="boring">   pub const fn new() -&gt; Self {
</span><span class="boring">       Self {
</span><span class="boring">           admins: Map::new(&quot;admins&quot;),
</span><span class="boring">       }
</span><span class="boring">   }
</span>    ...

    #[msg(instantiate)]
    pub fn instantiate(
        &amp;self,
        ctx: (DepsMut, Env, MessageInfo),
        admins: Vec&lt;String&gt;,
    ) -&gt; StdResult&lt;Response&gt; {
        let (deps, _, _) = ctx;

        for admin in admins {
            let admin = deps.api.addr_validate(&amp;admin)?;
            self.admins.save(deps.storage, &amp;admin, &amp;Empty {})?;
        }

        Ok(Response::new())
    }
}
</code></pre>
<p>Voila, that's all that is needed to update the state! With this change when we expand <code>contract</code>
macro we should see:</p>
<pre><code class="language-rust noplayground">#[allow(clippy::derive_partial_eq_without_eq)]
#[derive(
    sylvia::serde::Serialize,
    sylvia::serde::Deserialize,
    Clone,
    Debug,
    PartialEq,
    sylvia::schemars::JsonSchema,
)]
#[serde(rename_all = &quot;snake_case&quot;)]
pub struct InstantiateMsg {
    pub admins: Vec&lt;String&gt;,
}
impl InstantiateMsg {
    pub fn dispatch(
        self,
        contract: &amp;AdminContract&lt;'_&gt;,
        ctx: (
            cosmwasm_std::DepsMut,
            cosmwasm_std::Env,
            cosmwasm_std::MessageInfo,
        ),
    ) -&gt; StdResult&lt;Response&gt; {
        let Self { admins } = self;
        contract.instantiate(ctx.into(), admins).map_err(Into::into)
    }
}
</code></pre>
<p>As you can see, admins was set as a field of <code>InstantiateMsg</code>, and in <code>dispatch</code>, it's forwarded to
instantiate implemented in our contract. There <code>vector</code> of strings is being transformed into a
<code>vector</code> of <code>Addr</code>. We cannot take addresses as a message argument because only some strings are
valid addresses. It might be confusing once we are working on tests. Any string could be used
in the place of address.</p>
<p>Let me explain. Every string can be technically considered an address. However, not every string is
an actual existing blockchain address. When we keep anything of type <code>Addr</code> in the contract, we
assume it is a proper address in the blockchain. That is why the
<a href="https://docs.rs/cosmwasm-std/1.1.0/cosmwasm_std/trait.Api.html#tymethod.addr_validate"><code>addr_validate</code></a>
function exits - to check this precondition.</p>
<p>Having data to store, we use the
<a href="https://docs.rs/cw-storage-plus/0.16.0/cw_storage_plus/struct.Map.html#method.save"><code>save</code></a>
function to write it into the contract state. Note that the first argument of <code>save</code> is
<a href="https://docs.rs/cosmwasm-std/1.1.0/cosmwasm_std/trait.Storage.html"><code>&amp;mut Storage</code></a>, which is
actual blockchain storage. As emphasized, the <code>Map</code> object stores nothing and is an accessor.
It determines how to store the data in the storage given to it. The second argument is the
serializable data to be stored, and the last one is the value which in our case is <code>Empty</code>.</p>
<p>With the state added to our contract, let's also update the entry_point. Go to <code>src/lib.rs</code>:</p>
<pre><code class="language-rust noplayground">pub mod contract;

use cosmwasm_std::{entry_point, DepsMut, Empty, Env, MessageInfo, Response, StdResult};

use crate::contract::{InstantiateMsg, AdminContract};

const CONTRACT: AdminContract = AdminContract::new();

#[entry_point]
pub fn instantiate(
    deps: DepsMut,
    env: Env,
    info: MessageInfo,
    msg: InstantiateMsg,
) -&gt; StdResult&lt;Response&gt; {
    msg.dispatch(&amp;CONTRACT, (deps, env, info))
}
</code></pre>
<p>Instead of passing the <code>&amp;AdminContract</code> to the <code>dispatch</code> method, we first create the inner value
<code>CONTRACT</code> by calling <code>AdminContract::new()</code>.</p>
<p>Nice, we now have the state initialized on our contract, but we can't validate if the data is
stored correctly. Let's change it in the next chapter, in which we will introduce <code>query</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../basics/first-messages.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../basics/query.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../basics/first-messages.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../basics/query.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
