<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introducing multitest - Sylvia book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Guide to building CosmWasm smart contracts">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting started</li><li class="chapter-item expanded "><a href="../setting-up-env.html"><strong aria-hidden="true">1.</strong> Setting up the environment</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start.html"><strong aria-hidden="true">2.</strong> Quick start with wasmd</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../wasmd-quick-start/testnet.html"><strong aria-hidden="true">2.1.</strong> Testnet setup</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start/preparing-account.html"><strong aria-hidden="true">2.2.</strong> Preparing account</a></li><li class="chapter-item expanded "><a href="../wasmd-quick-start/testnet-interaction.html"><strong aria-hidden="true">2.3.</strong> Interaction with testnet</a></li><li class="chapter-item expanded "><a href="../basics/building-contract.html"><strong aria-hidden="true">2.4.</strong> Building the contract</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Smart contracts</li><li class="chapter-item expanded "><a href="../basics.html"><strong aria-hidden="true">3.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basics/create-project.html"><strong aria-hidden="true">3.1.</strong> Create a Rust project</a></li><li class="chapter-item expanded "><a href="../basics/entry-points.html"><strong aria-hidden="true">3.2.</strong> Entry points</a></li><li class="chapter-item expanded "><a href="../basics/first-messages.html"><strong aria-hidden="true">3.3.</strong> Generating first messages</a></li><li class="chapter-item expanded "><a href="../basics/state.html"><strong aria-hidden="true">3.4.</strong> Contract state</a></li><li class="chapter-item expanded "><a href="../basics/query.html"><strong aria-hidden="true">3.5.</strong> Creating a query</a></li><li class="chapter-item expanded "><a href="../basics/query-testing.html"><strong aria-hidden="true">3.6.</strong> Testing a query</a></li><li class="chapter-item expanded "><a href="../basics/multitest-intro.html" class="active"><strong aria-hidden="true">3.7.</strong> Introducing multitest</a></li><li class="chapter-item expanded "><a href="../basics/execute.html"><strong aria-hidden="true">3.8.</strong> Execution messsages</a></li><li class="chapter-item expanded "><a href="../basics/events.html"><strong aria-hidden="true">3.9.</strong> Events attributes and data</a></li><li class="chapter-item expanded "><a href="../basics/funds.html"><strong aria-hidden="true">3.10.</strong> Dealing with funds</a></li><li class="chapter-item expanded "><a href="../basics/good-practices.html"><strong aria-hidden="true">3.11.</strong> Good practices</a></li><li class="chapter-item expanded "><a href="../basics/fp-types.html"><strong aria-hidden="true">3.12.</strong> Floating point types</a></li><li class="chapter-item expanded "><a href="../basics/reusability.html"><strong aria-hidden="true">3.13.</strong> Reusability</a></li></ol></li><li class="chapter-item expanded "><a href="../actor-model.html"><strong aria-hidden="true">4.</strong> The Actor Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../actor-model/idea.html"><strong aria-hidden="true">4.1.</strong> The idea</a></li><li class="chapter-item expanded "><a href="../actor-model/actors-in-blockchain.html"><strong aria-hidden="true">4.2.</strong> Actors in the blockchain</a></li><li class="chapter-item expanded "><a href="../actor-model/contract-as-actor.html"><strong aria-hidden="true">4.3.</strong> Contract as an actor</a></li></ol></li><li class="chapter-item expanded "><a href="../impressum.html">Legal Information</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Sylvia book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introducing-multitest"><a class="header" href="#introducing-multitest">Introducing multitest</a></h1>
<p>Let me introduce the <a href="https://crates.io/crates/cw-multi-test"><code>multitest</code></a> -
library for creating tests for smart contracts in Rust.</p>
<p>The core idea of <code>multitest</code> is abstracting an entity of contract and
simulating the blockchain environment for testing purposes. The purpose of this
is to be able to test communication between smart contracts. It does its job
well, but it is also an excellent tool for testing single-contract scenarios.</p>
<h2 id="update-dependencies"><a class="header" href="#update-dependencies">Update dependencies</a></h2>
<p>First, we need to add a <a href="https://docs.rs/cw-multi-test/latest/cw_multi_test/"><code>cw-multi-test</code></a> to
our <code>Cargo.toml</code>. We will also add <a href="https://docs.rs/anyhow/1.0.66/anyhow/"><code>anyhow</code></a>. We will use it
to bail on calls to unimplemented entry points like <code>reply</code>, <code>migrate</code>, and <code>sudo</code>.</p>
<pre><code class="language-toml">[package]
name = &quot;contract&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[lib]
crate-type = [&quot;cdylib&quot;]

[features]
library = []

[dependencies]
cosmwasm-std = { version = &quot;1.1&quot;, features = [&quot;staking&quot;] }
cosmwasm-schema = &quot;1.1.6&quot;
serde = { version = &quot;1.0.147&quot;, features = [&quot;derive&quot;] }
sylvia = &quot;0.2.1&quot;
schemars = &quot;0.8.11&quot;
cw-storage-plus = &quot;0.16.0&quot;

[dev-dependencies]
anyhow = &quot;1&quot;
cw-multi-test = &quot;0.16&quot;
</code></pre>
<p>I added a new
<a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#development-dependencies"><code>[dev-dependencies]</code></a>
section with dependencies not used by the final binary
but which may be used by tools around the development process - for example, tests.</p>
<h2 id="creating-a-module-for-tests"><a class="header" href="#creating-a-module-for-tests">Creating a module for tests</a></h2>
<p>Now we will create a new module, <code>multitest</code>. Let's first add it to the <code>src/lib.rs</code></p>
<pre><code class="language-rust noplayground">pub mod contract;
pub mod responses;

#[cfg(test)]
mod multitest;

<span class="boring">use cosmwasm_std::{entry_point, Binary, Deps, DepsMut, Env, MessageInfo, Response};
</span><span class="boring">
</span><span class="boring">use crate::contract::{AdminContract, ContractQueryMsg, InstantiateMsg};
</span><span class="boring">
</span><span class="boring">const CONTRACT: AdminContract = AdminContract::new();
</span><span class="boring">
</span><span class="boring">#[entry_point]
</span><span class="boring">pub fn instantiate(
</span><span class="boring">   deps: DepsMut,
</span><span class="boring">   env: Env,
</span><span class="boring">   info: MessageInfo,
</span><span class="boring">   msg: InstantiateMsg,
</span><span class="boring">) -&gt; StdResult&lt;Response&gt; {
</span><span class="boring">   msg.dispatch(&amp;CONTRACT, (deps, env, info))
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[entry_point]
</span><span class="boring">pub fn query(deps: Deps, env: Env, msg: ContractQueryMsg) -&gt; StdResult&lt;Binary&gt; {
</span><span class="boring">   msg.dispatch(&amp;CONTRACT, (deps, env))
</span><span class="boring">}
</span></code></pre>
<p>As this module is purely for testing purpose, we prefix it with
<a href="https://doc.rust-lang.org/book/ch11-03-test-organization.html#the-tests-module-and-cfgtest"><code>#[cfg(test)]</code></a>.</p>
<p>Now create <code>src/multitest.rs</code>.</p>
<pre><code class="language-rust noplayground">use anyhow::{bail, Result as AnyResult};
use cosmwasm_std::{from_slice, Empty};
use cw_multi_test::Contract;

use crate::contract::{AdminContract, ContractExecMsg, ContractQueryMsg, InstantiateMsg};

mod proxy;
mod tests;

impl Contract&lt;Empty&gt; for AdminContract&lt;'_&gt; {
    fn execute(
        &amp;self,
        deps: cosmwasm_std::DepsMut&lt;Empty&gt;,
        env: cosmwasm_std::Env,
        info: cosmwasm_std::MessageInfo,
        msg: Vec&lt;u8&gt;,
    ) -&gt; AnyResult&lt;cosmwasm_std::Response&lt;Empty&gt;&gt; {
        from_slice::&lt;ContractExecMsg&gt;(&amp;msg)?
            .dispatch(self, (deps, env, info))
            .map_err(Into::into)
    }

    fn instantiate(
        &amp;self,
        deps: cosmwasm_std::DepsMut&lt;Empty&gt;,
        env: cosmwasm_std::Env,
        info: cosmwasm_std::MessageInfo,
        msg: Vec&lt;u8&gt;,
    ) -&gt; AnyResult&lt;cosmwasm_std::Response&lt;Empty&gt;&gt; {
        from_slice::&lt;InstantiateMsg&gt;(&amp;msg)?
            .dispatch(self, (deps, env, info))
            .map_err(Into::into)
    }

    fn query(
        &amp;self,
        deps: cosmwasm_std::Deps&lt;Empty&gt;,
        env: cosmwasm_std::Env,
        msg: Vec&lt;u8&gt;,
    ) -&gt; AnyResult&lt;cosmwasm_std::Binary&gt; {
        from_slice::&lt;ContractQueryMsg&gt;(&amp;msg)?
            .dispatch(self, (deps, env))
            .map_err(Into::into)
    }

    fn sudo(
        &amp;self,
        _deps: cosmwasm_std::DepsMut&lt;Empty&gt;,
        _env: cosmwasm_std::Env,
        _msg: Vec&lt;u8&gt;,
    ) -&gt; AnyResult&lt;cosmwasm_std::Response&lt;Empty&gt;&gt; {
        bail!(&quot;sudo not implemented for contract&quot;)
    }

    fn reply(
        &amp;self,
        _deps: cosmwasm_std::DepsMut&lt;Empty&gt;,
        _env: cosmwasm_std::Env,
        _msg: cosmwasm_std::Reply,
    ) -&gt; AnyResult&lt;cosmwasm_std::Response&lt;Empty&gt;&gt; {
        bail!(&quot;reply not implemented for contract&quot;)
    }

    fn migrate(
        &amp;self,
        _deps: cosmwasm_std::DepsMut&lt;Empty&gt;,
        _env: cosmwasm_std::Env,
        _msg: Vec&lt;u8&gt;,
    ) -&gt; AnyResult&lt;cosmwasm_std::Response&lt;Empty&gt;&gt; {
        bail!(&quot;reply not implemented for contract&quot;)
    }
}
</code></pre>
<p>So first, we added <code>mod proxy</code> and <code>mod tests</code>. We will create these files in the next step.</p>
<p>We impl <a href="https://docs.rs/cw-multi-test/0.16.1/cw_multi_test/trait.Contract.html"><code>Contract</code></a><Empty>
for <code>AdminContract</code>. This will allow us to use it in a <code>cw-multi-test</code> environment. To use it, we
have to implement six entry points, but currently, our contract supports only two of them,
<code>instantiate</code> and <code>query</code>. For unsupported entry points, we will call
<a href="https://docs.rs/anyhow/latest/anyhow/macro.bail.html"><code>bail!</code></a>. We will handle supported ones
simmiliary as we did in <code>src/lib.rs</code>. The difference here is that interface <code>Contract</code> forces us to
pass messages to entry points as binary slices. We can work with this by using
<a href="https://docs.rs/cosmwasm-std/0.16.0/cosmwasm_std/fn.from_slice.html"><code>from_slice</code></a>.
This function will parse binary slice to our message. We will then dispatch them as we did in
<code>src/lib.rs</code> entry points and <code>map_err</code> in case any error is returned.</p>
<h2 id="prepare-proxy"><a class="header" href="#prepare-proxy">Prepare proxy</a></h2>
<p>Now we will prepare a proxy for our contract. Our goal here is to remove repetitiveness and hide
serialization from our tests. It will pay off after a while, but you will appreciate this approach
as your contract grows,</p>
<p>Create <code>src/multitest/proxy.rs</code> and paste to it:</p>
<pre><code class="language-rust noplayground">use cosmwasm_std::{Addr, StdResult};
use cw_multi_test::{App, Executor};

use crate::{
    contract::{AdminContract, InstantiateMsg, QueryMsg},
    responses::AdminListResp,
};

#[derive(Clone, Copy, Debug, PartialEq, Eq)]
pub struct AdminContractCodeId(u64);

impl AdminContractCodeId {
    pub fn store_code(app: &amp;mut App) -&gt; Self {
        let code_id = app.store_code(Box::new(AdminContract::new()));
        Self(code_id)
    }

    #[track_caller]
    pub fn instantiate(
        self,
        app: &amp;mut App,
        sender: &amp;Addr,
        admins: Vec&lt;String&gt;,
        label: &amp;str,
        admin: Option&lt;String&gt;,
    ) -&gt; StdResult&lt;AdminContractProxy&gt; {
        let msg = InstantiateMsg { admins };

        app.instantiate_contract(self.0, sender.clone(), &amp;msg, &amp;[], label, admin)
            .map_err(|err| err.downcast().unwrap())
            .map(AdminContractProxy)
    }
}

#[derive(Debug)]
pub struct AdminContractProxy(Addr);

impl AdminContractProxy {
    #[track_caller]
    pub fn admin_list(&amp;self, app: &amp;App) -&gt; StdResult&lt;AdminListResp&gt; {
        let msg = QueryMsg::AdminList {};

        app.wrap().query_wasm_smart(self.0.clone(), &amp;msg)
    }
}

</code></pre>
<p>Two new structures here: <code>AdminContractCodeId</code> and <code>AdminContractProxy</code>.
<code>AdminContractCodeId</code> will store <code>u64</code> which represents the code id of our contract registered on
a blockchain generated by <a href="https://docs.rs/cw-multi-test/latest/cw_multi_test/struct.App.html#method.store_code"><code>store_code</code></a>.
We can use <a href="https://docs.rs/cw-multi-test/latest/cw_multi_test/trait.Executor.html#method.instantiate_contract"><code>instantiate_contract</code></a>
with acquired code id and map address of received contract <code>addr</code>. It will on <code>instantiate</code> return
the <code>AdminContractProxy</code>, which responsibility will be to send messages to our contract.</p>
<h2 id="first-multitest"><a class="header" href="#first-multitest">First multitest</a></h2>
<p>Now we are ready to write our first multitest. Let's proceed with creating <code>src/multitest/tests.rs</code>.</p>
<pre><code class="language-rust noplayground">use cosmwasm_std::Addr;
use cw_multi_test::App;

use crate::{multitest::proxy::AdminContractCodeId, responses::AdminListResp};

#[test]
fn basic() {
    let mut app = App::default();

    let owner = Addr::unchecked(&quot;addr0001&quot;);
    let admins = vec![
        &quot;admin1&quot;.to_owned(),
        &quot;admin2&quot;.to_owned(),
        &quot;admin3&quot;.to_owned(),
    ];

    let code_id = AdminContractCodeId::store_code(&amp;mut app);

    let contract = code_id
        .instantiate(&amp;mut app, &amp;owner, admins.clone(), &quot;Cw20 contract&quot;, None)
        .unwrap();

    let resp = contract.admin_list(&amp;app).unwrap();

    assert_eq!(resp, AdminListResp { admins });
}
</code></pre>
<p>We will first create default <a href="https://docs.rs/cw-multi-test/latest/cw_multi_test/struct.App.html#"><code>App</code></a>.
This will cache the state of our contract. We will create an owner of our contract using
<a href="https://docs.rs/cosmwasm-std/0.14.0/cosmwasm_std/struct.Addr.html#method.unchecked"><code>Addr::unchecked</code></a>.
Call <code>store_code</code> on our <code>App</code> to acquire code id and then init the contract which will return
<code>AdminContractProxy</code>.
We instantiate it with three admins, which we will then query using the <code>admin_list</code> method on the
proxy. This should return to us <code>AdminListResp</code> with all three of them.</p>
<p>The test should pass, and we should have our first multitest. We will later expand it when we will
have more functionality to test.
Let's allow our contract to change its state using the <code>execute</code> message in next the chapter.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../basics/query-testing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../basics/execute.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../basics/query-testing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../basics/execute.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
